# NB10 Windows - 使用场景详细指南

**文档版本**: 1.0
**最后更新**: 2025-10-15
**目标读者**: 临床医生、医学研究人员

---

## 📖 目录

1. [核心原则：NB10的独立性](#核心原则nb10的独立性)
2. [场景对比：单独NB10 vs 多模态](#场景对比单独nb10-vs-多模态)
3. [决策树：如何选择使用场景](#决策树如何选择使用场景)
4. [场景A详解：单独NB10分析](#场景a详解单独nb10分析)
5. [场景B详解：多模态特征整合](#场景b详解多模态特征整合)
6. [常见问题解答](#常见问题解答)
7. [技术支持与资源](#技术支持与资源)

---

## 核心原则：NB10的独立性

### ✅ 最重要的一点

**NB10是一个完全独立的AI-CAC评分工具，无需任何前置步骤即可运行！**

```
输入: DICOM文件
  ↓
NB10处理
  ↓
输出: AI-CAC冠状动脉钙化评分
```

### 为什么强调独立性？

1. **临床实用性**
   - 医生不需要学习复杂的深度学习流程
   - 不需要安装TotalSegmentator等复杂工具
   - 不需要了解L1椎体定位、脂肪分割等技术细节

2. **高可靠性**
   - 成功率: 99.5% (196/197例)
   - 处理速度: ~15秒/患者
   - 部署简单: 仅需500MB模型

3. **适合日常临床工作**
   - 快速响应门诊需求
   - 单个患者即时评估
   - 批量数据稳定处理

### 何时不需要其他Notebook？

- ✅ 只需要钙化评分
- ✅ 单模态研究（仅AI-CAC）
- ✅ 临床快速诊断
- ✅ 风险分层评估

### 何时才需要其他Notebook？

- ⚠️ 仅当需要多模态特征整合研究时
- ⚠️ 需要脂肪体积、主动脉结构等额外生物标志物时
- ⚠️ 发表"多模态整合"相关论文时

---

## 场景对比：单独NB10 vs 多模态

### 📊 全面对比表

| 维度 | 场景A: 单独NB10 | 场景B: 多模态分析 | 推荐度 |
|-----|----------------|-----------------|--------|
| **适用人群** | | | |
| 临床医生 | ✅ 强烈推荐 | ❌ 不推荐 | A |
| 医学研究人员（单模态） | ✅ 推荐 | ❌ 不需要 | A |
| 医学研究人员（多模态） | ✅ 基础数据 | ⭐ 高级分析 | A+B |
| | | | |
| **技术要求** | | | |
| 前置Notebook | ✅ 无 | ⚠️ NB08+NB09 | A |
| 深度学习经验 | ✅ 不需要 | ⚠️ 需要 | A |
| GPU要求 | 🟢 6GB即可 | 🔴 16GB+ | A |
| 部署难度 | 🟢 简单 | 🔴 复杂 | A |
| 维护成本 | 🟢 低 | 🔴 高 | A |
| | | | |
| **性能指标** | | | |
| 处理时间/患者 | ~15秒 | ~10-20分钟 | A |
| 成功率 | 99.5% | ~50% (完整链) | A |
| 磁盘空间 | ~500MB | ~5GB+ | A |
| | | | |
| **输出结果** | | | |
| AI-CAC评分 | ✅ 3个特征 | ✅ 3个特征 | 两者都有 |
| 脂肪特征 | ❌ 无 | ✅ 6个特征 | B |
| 主动脉结构 | ❌ 无 | ✅ 2个特征 | B |
| 总生物标志物 | 3个 | 11个 | B更全面 |
| PSM统计分析 | ❌ 无 | ✅ 有 | B |
| | | | |
| **适用场景** | | | |
| 日常门诊 | ✅ 完美 | ❌ 太慢 | A |
| 快速筛查 | ✅ 理想 | ❌ 不适合 | A |
| 单模态研究 | ✅ 足够 | ❌ 过度 | A |
| 多模态论文 | 🟡 基础 | ⭐ 必需 | A+B |
| 批量科研数据 | ✅ 可靠 | 🟡 可用但慢 | A |

### 关键发现

1. **对于99%的临床使用场景，场景A已经足够**
2. **场景B主要用于特定的多模态科研项目**
3. **不要为了"功能完整"而牺牲"可靠性和速度"**

---

## 决策树：如何选择使用场景

```
开始：我需要AI-CAC冠脉钙化评分
  ↓
问题1：是否只需要钙化评分？
  ├─ 是 → 【使用场景A】单独NB10 ✅ 完成
  └─ 否 → 继续
           ↓
         问题2：是否需要脂肪特征或主动脉结构数据？
           ├─ 否 → 【使用场景A】单独NB10 ✅ 完成
           └─ 是 → 继续
                    ↓
                  问题3：是否有技术团队支持NB08/NB09安装？
                    ├─ 否 → 【建议】先用场景A，联系技术支持
                    └─ 是 → 继续
                             ↓
                           问题4：能否接受50%的完整链成功率？
                             ├─ 否 → 【建议】等待NB09优化后再用场景B
                             └─ 是 → 【使用场景B】多模态分析 ⭐
```

### 决策建议

**如果您不确定**：
1. **先用场景A验证工具** - 5分钟就能看到结果
2. **评估是否满足需求** - 大多数情况下已经足够
3. **再考虑是否需要场景B** - 避免不必要的复杂性

---

## 场景A详解：单独NB10分析

### 适用场景

#### 1️⃣ 日常临床门诊
```
患者: 45岁男性，胸痛
医生: 需要评估冠脉钙化风险
  ↓
使用NB10: 15秒获得AI-CAC评分
  ↓
结果: Agatston=150 (中度风险)
  ↓
决策: 建议进一步检查
```

#### 2️⃣ 单模态科研项目
```
研究课题: "早发冠心病患者的冠脉钙化特征"
样本: CHD组100例 vs Normal组96例
  ↓
使用NB10: 批量处理196例
  ↓
结果: CHD组Agatston显著高于Normal组 (P<0.001)
  ↓
论文: 单模态AI-CAC研究
```

#### 3️⃣ 快速风险筛查
```
体检中心: 1000例胸部CT筛查
目标: 识别高钙化风险人群
  ↓
使用NB10: 批量处理 (99.5%成功率)
  ↓
结果: 筛选出200例高风险患者
  ↓
行动: 建议专科就诊
```

### 操作流程

#### Step 1: 安装NB10
```bash
# 1. 下载并解压nb10_windows
# 2. 安装依赖
pip install -r deployment/requirements_cpu.txt

# 3. 下载模型
python deployment/download_models.py

# 4. 验证安装
python scripts/validate_installation.py
```

#### Step 2: 配置数据路径
```bash
# 编辑config/config.yaml
data_dir: "D:/DICOM_Data/CHD"   # 您的DICOM数据路径
output_dir: "./output/chd"       # 输出路径
```

#### Step 3: 运行分析
```bash
# 测试模式 (处理5例)
nb10 test

# 完整处理
nb10 chd      # 处理CHD组
nb10 normal   # 处理Normal组

# 统计分析
nb10 analyze
```

#### Step 4: 查看结果
```
output/
├── nb10_results_20251015_094824.csv   # 详细评分数据
├── summary_statistics.txt              # 统计摘要
└── visualization/
    ├── agatston_distribution.png       # 评分分布图
    └── risk_stratification.png         # 风险分层图
```

### 输出数据说明

#### CSV文件列说明
```csv
patient_id,           # 患者ID
agatston_score,       # Agatston钙化评分
volume_score,         # 体积评分
mass_score,           # 质量评分
risk_category,        # 风险分层 (低/中/高)
processing_time,      # 处理时间
status               # 处理状态 (success/failed)
```

#### 风险分层标准
- **低风险**: Agatston < 100
- **中度风险**: 100 ≤ Agatston < 400
- **高风险**: Agatston ≥ 400

---

## 场景B详解：多模态特征整合

### 适用场景

#### 1️⃣ 多模态特征整合论文
```
研究课题: "多模态特征整合提高早发CAD预警准确率"
需要数据:
  - AI-CAC钙化评分 (3个特征)
  - 主动脉旁脂肪 (6个特征)
  - 主动脉结构 (2个特征)
  = 11个生物标志物
  ↓
使用场景B: 完整多模态流程
  ↓
输出: PSM匹配队列 + 多变量分析结果
  ↓
论文: 多模态整合研究
```

#### 2️⃣ 综合心血管风险评估模型
```
目标: 建立综合风险预测模型
特征: 钙化 + 脂肪 + 结构 + 临床指标
  ↓
使用场景B: 提取所有生物标志物
  ↓
模型: 机器学习多变量模型
  ↓
应用: 精准风险分层
```

### 前置准备（重要！）

#### 必须先完成的任务

**1. 安装NB08 (L1椎体定位)**
```bash
# 位置: colab/08_vertebra_localization/
# 依赖: TotalSegmentator
# 时间: ~5分钟/例
# 成功率: 100%
```

**2. 安装NB09 (主动脉旁脂肪提取)**
```bash
# 位置: colab/09_periaortic_fat_extraction/
# 依赖: NB08结果
# 时间: ~5分钟/例
# 成功率: 51% (薄层数据)
```

**3. 准备临床数据**
```
文件: CHD_comprehensive_data.xlsx
内容: 患者ID、性别、年龄、代谢指标等
```

#### ⚠️ 注意事项

1. **数据版本一致性**
   - NB08/NB09/NB10必须使用相同的DICOM数据集
   - 注意thick slice (V1.x) vs thin slice (V2.x)版本

2. **Patient ID匹配**
   - NB08: `dicom_5527999` 格式
   - NB09: `dicom_5527999` 格式
   - NB10: `dicom_7091064.zip_1668410` 格式
   - 系统会自动提取和匹配

3. **成功率预期**
   - NB08成功: 174/174 (100%)
   - NB09成功: 89/174 (51%)
   - NB10成功: 196/197 (99.5%)
   - **完整链成功**: ~50%

### 操作流程

#### Step 1: 运行前置Notebooks
```bash
# 1. 运行NB08
cd ../../colab/08_vertebra_localization/
python run_nb08.py --data-dir /path/to/dicom

# 2. 运行NB09 (依赖NB08结果)
cd ../09_periaortic_fat_extraction/
python run_nb09.py --data-dir /path/to/dicom

# 3. 验证结果文件
ls ../../results/nb08_vertebrae/results/nb08_vertebrae/l1_positions.csv
ls ../../results/nb09_periaortic_fat/periaortic_fat_features_*.csv
```

#### Step 2: 运行NB10
```bash
cd ../../tools/nb10_windows/
nb10 chd
nb10 normal
```

#### Step 3: 执行多模态整合
```bash
# 运行整合脚本
python integrate_multimodal_data.py

# 输出位置
ls output/multimodal_analysis/
```

#### Step 4: 查看分析结果
```
output/multimodal_analysis/
├── COMPREHENSIVE_SUMMARY.md          # 完整分析报告 ⭐
├── psm_matched_cohort.csv            # PSM匹配队列
├── multimodal_features_analysis.csv  # 特征统计结果
├── forest_plot.png                   # 森林图
├── correlation_heatmap.png           # 相关性热图
└── propensity_score_plot.png         # 倾向性评分图
```

### 输出数据说明

#### 多模态特征列表 (11个)

**模态1: AI-CAC冠脉钙化 (3个特征)**
- `agatston_score`: Agatston评分
- `volume_score`: 体积评分
- `mass_score`: 质量评分

**模态2: 主动脉旁脂肪 (6个特征)**
- `fat_volume_ml_5mm`: 脂肪体积 (5mm环)
- `fat_mean_density_hu_5mm`: 脂肪平均密度
- `fat_std_density_hu_5mm`: 脂肪密度标准差
- `fat_volume_ml_7mm`: 脂肪体积 (7mm环)
- `fat_mean_density_hu_7mm`: 脂肪平均密度
- `fat_std_density_hu_7mm`: 脂肪密度标准差

**模态3: 主动脉结构 (2个特征)**
- `aorta_volume_ml`: 主动脉体积
- `aorta_average_diameter_mm`: 主动脉平均直径

#### PSM匹配结果
```
原始队列: CHD 100例, Normal 96例
PSM匹配后: CHD 99例, Normal 99例 (1:1配对)
匹配质量:
  - 性别 SMD: 0.753 → 0.000 ✅
  - 年龄 SMD: -0.383 → 0.021 ✅
```

---

## 常见问题解答

### Q1: 我只需要钙化评分，需要安装NB08/NB09吗？

**A**: **不需要！** NB10可以完全独立运行。

- ✅ 直接使用场景A
- ✅ 仅需DICOM文件
- ✅ 无需任何前置步骤

---

### Q2: 多模态分析的成功率为什么这么低？

**A**: 主要受NB09成功率限制（51%）。

**原因**:
- NB09处理薄层数据难度大
- L1椎体定位依赖数据质量
- 脂肪分割对图像质量敏感

**解决方案**:
- 等待NB08重新运行完成 (使用薄层数据)
- 预期NB09成功率会提升到80%+
- 或者使用场景A (99.5%成功率)

---

### Q3: 如果我现在用场景A，以后能升级到场景B吗？

**A**: **可以！** 这正是推荐的渐进式策略。

**步骤**:
1. 先用场景A获得AI-CAC数据
2. 评估是否满足研究需求
3. 如需要，再安装NB08/NB09
4. 运行多模态整合脚本

**优点**:
- 快速验证工具可用性
- 避免不必要的复杂部署
- 数据可复用

---

### Q4: 部署NB08/NB09需要什么条件？

**A**: 需要较高的技术门槛。

**硬件要求**:
- GPU: 16GB+ 显存
- 内存: 32GB+
- 磁盘: 50GB+

**软件要求**:
- TotalSegmentator
- PyTorch 深度学习框架
- 多个Python依赖包

**技术要求**:
- 熟悉深度学习环境配置
- 了解医学图像处理
- 能解决依赖冲突问题

**建议**: 联系技术支持团队协助部署

---

### Q5: 为什么不把所有功能集成到一个工具？

**A**: 基于可靠性和实用性的权衡。

**如果集成**:
- ❌ 成功率从99.5%降到50%
- ❌ 处理时间从15秒增加到10-20分钟
- ❌ 部署难度大幅增加
- ❌ 维护成本提高

**当前模块化方案**:
- ✅ NB10保持高可靠性 (99.5%)
- ✅ 适合临床日常使用
- ✅ 可选的多模态扩展
- ✅ 降低医生学习门槛

**原则**: **不为功能完整性牺牲可靠性**

---

### Q6: 场景A和场景B的数据能否合并？

**A**: **可以**，场景A是场景B的子集。

**关系**:
```
场景B输出 = 场景A输出 + 脂肪特征 + 主动脉结构
```

**使用方式**:
- 先用场景A获得AI-CAC数据
- 数据保存在 `output/nb10_results_*.csv`
- 场景B会自动读取这些文件
- 整合后输出到 `output/multimodal_analysis/`

---

### Q7: 多模态分析需要多长时间？

**A**: 取决于数据量和硬件配置。

**时间估算**:
```
100例患者:
  NB08: ~8小时 (5分钟/例)
  NB09: ~8小时 (5分钟/例)
  NB10: ~25分钟 (15秒/例)
  整合: ~5分钟
  总计: ~16.5小时
```

**对比**:
```
100例患者 (仅场景A):
  NB10: ~25分钟
  分析: ~2分钟
  总计: ~27分钟
```

**建议**: 如果时间紧迫，优先使用场景A

---

## 技术支持与资源

### 文档资源

| 文档 | 说明 | 推荐度 |
|------|------|--------|
| [README.md](../README.md) | 项目总览和快速开始 | ⭐⭐⭐ |
| [INSTALLATION_GUIDE.md](INSTALLATION_GUIDE.md) | 详细安装指南 | ⭐⭐⭐ |
| [USER_MANUAL.md](USER_MANUAL.md) | 完整用户手册 | ⭐⭐ |
| [DATA_VERSION_TRACKING.md](DATA_VERSION_TRACKING.md) | 数据版本追踪 | ⭐⭐ |
| [COMPREHENSIVE_SUMMARY.md](../output/multimodal_analysis/COMPREHENSIVE_SUMMARY.md) | 多模态分析总结 | ⭐ |

### 联系方式

**问题反馈**:
- GitHub Issues: [cardiac-ml-research/issues](https://github.com/zhurong2020/cardiac-ml-research/issues)
- Email: [添加联系邮箱]

**技术支持**:
- NB10使用问题: 联系研究团队
- NB08/NB09部署: 联系技术支持团队
- 多模态分析咨询: 联系数据分析团队

### 更新记录

- **2025-10-15**: 首次发布，明确场景A和场景B的区别和使用建议

---

**最后更新**: 2025-10-15
**维护者**: 陈医生团队
